想象一下多个不相交或完全包含的区间，他们的结构其实是一棵树。外层为父亲，内层为儿子。

要计算的是最大值的期望，而这个最大值是由多个操作得到的，所以无法分别计算期望再合并。解决这个问题的方法是先算出概率，再得到期望。

到最后，一个区间 $[l,r]$的最大值只可能是 $[mx,mx+q]$ 中的数（$mx$ 为原序列中这个区间的最大值）。那么那么我们可以用这个东西来 dp。

设 $f[x][j]​$ 表示 $x​$ 点子树中的操作结束后，$x​$点表示的这个区间的最大值小于等于 $mx_x+j​$ 的概率。这样设计是因为若是等于的话，计算的时候转移还是要求前缀和，相当于是小于等于了。若 $x​$ 这个操作不执行，那么从子树 $v​$ 转移，子树 $v​$ 需要让其最后的区间最大值小于等于 $mx_x+j​$ ；若执行，那么子树的需要让其区间最大值小于等于 $mx_i+j-1​$ 。因此有转移
$f[x][j]=p_x\prod f[v][mx_x+j-1-mx_v]+(1-p_x)\prod f[v][mx_x+j-mx_v] $